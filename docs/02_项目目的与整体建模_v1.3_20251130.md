# 项目目的与整体建模

> **文档版本**: v1.3  
> **创建时间**: 2025-11-30 12:49  
> **最后更新时间**: 2025-11-30 20:05  
> **状态**: ✅ 模型验证通过

---

## 1. 项目目的

### 1.1 学术目标

1. **复现基准**: 实现论文中基于 SAC 的热储能控制策略
2. **方法创新**: 
   - Innovation B: 碳排放感知的双目标优化
   - Innovation C: Transformer 时序特征提取
3. **工具升级**: EnergyPlus 23.2 替代 TRNSYS，提升仿真保真度

### 1.2 技术目标

| 目标 | 指标 | v1.3 达成状态 |
|------|------|---------------|
| 模型可运行 | 0 Severe/Fatal Errors | ✅ 通过 |
| 物理真实性 | 温度依赖 COP, 分层 TES | ✅ 实现 |
| RL 可控性 | EMS Actuator + Schedule 控制 | ✅ 配置 |
| 观测完整性 | DRL 状态空间全覆盖 | ✅ 148 变量 |

---

## 2. 系统架构

### 2.1 整体框架

```
┌─────────────────────────────────────────────────────────────┐
│                    RL Agent (Transformer-SAC)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ State Encoder│  │ Policy Net  │  │ Value Net   │         │
│  │ (Transformer)│  │   (MLP)     │  │   (MLP)     │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                  Gymnasium Environment                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Observation Space (dim=325)                          │   │
│  │ - Zone temps, TES nodes, HP status, Weather, Carbon  │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Action Space (dim=4)                                 │   │
│  │ - HW Setpoint, CW Setpoint, HP Avail, Chiller Avail  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                 EnergyPlus 23.2 Simulation                  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────┐ │
│  │ Heat Pump  │ │ Stratified │ │  Chiller   │ │ PV Array │ │
│  │ (EIR)      │ │ TES Tanks  │ │            │ │ 47 kW    │ │
│  └────────────┘ └────────────┘ └────────────┘ └──────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 节点拓扑 (v1.3 修复)

```
Hot Water Loop (Series Connection):
  HW Supply Inlet → HP Inlet → [Central_ASHP] → HP_Outlet_TES_Inlet
                                                       ↓
  HW Supply Outlet ← Central Boiler Outlet ← [TES_Stratified]

Chilled Water Loop (Series Connection):
  CW Supply Inlet → Chiller Inlet → [Central Chiller] → Chiller_Outlet_TES_Inlet
                                                              ↓
  CW Supply Outlet ← Central Chiller Outlet ← [Chilled_TES_Stratified]
```

---

## 3. 建筑模型

### 3.1 基础信息

| 参数 | 值 | 来源 |
|------|-----|------|
| 地点 | 上海 (31.23°N, 121.47°E) | 论文设定 |
| 建筑类型 | 大学教室 | 5Zone 模板 |
| 总面积 | ~500 m² | 4教室 + 走廊 |
| 占用人数 | 120人 (30人/教室) | 论文设定 |

### 3.2 围护结构

| 构件 | U 值 (W/m²K) | 标准依据 |
|------|--------------|----------|
| 外墙 | 0.30 | GB 50189-2015 夏热冬冷区 |
| 外窗 | 1.10 | Low-E 中空玻璃 |
| 屋顶 | 0.25 | 论文 Table A.10 |

### 3.3 HVAC 系统

| 设备 | 型号/配置 | 容量 |
|------|-----------|------|
| 热泵 | HeatPump:PlantLoop:EIR:Heating | 195.8 kW (COP 3.2) |
| 冷机 | Chiller:Electric:EIR | 63.8 kW (设计) |
| 热水 TES | WaterHeater:Stratified | 12 m³, 10节点 |
| 冷水 TES | WaterHeater:Stratified | 8 m³, 6节点 |
| 光伏 | Generator:Photovoltaic | 47 kW 峰值 |

---

## 4. 强化学习建模

### 4.1 状态空间 (Observation)

| 类别 | 变量数 | 示例 |
|------|--------|------|
| 区域温度 | 5 | Zone Mean Air Temperature |
| TES 分层 | 16 | Node 1-10 (HW) + Node 1-6 (CW) |
| 设备状态 | 6 | HP PLR, Chiller COP, Pump Rate |
| 气象数据 | 4 | OAT, Solar Radiation |
| 电网信息 | 2 | Carbon Intensity, TOU Price |
| 时间编码 | 3 | Hour, Day of Week, Month |
| **总计** | **36 基础** | 扩展至 325 (含历史窗口) |

### 4.2 动作空间 (Action)

| 动作 | 范围 | 控制目标 |
|------|------|----------|
| HW_Setpoint | [35, 55] °C | 热水供水温度 |
| CW_Setpoint | [5, 12] °C | 冷水供水温度 |
| HP_Availability | [0, 1] | 热泵开关 (峰值转移) |
| Chiller_Availability | [0, 1] | 冷机开关 (峰值转移) |

### 4.3 奖励函数

```python
reward = - cost_weight * electricity_cost 
         - carbon_weight * carbon_emission
         - comfort_penalty * comfort_violation

# 默认权重
cost_weight = 0.5
carbon_weight = 0.5
comfort_penalty = 10.0
```

### 4.4 上海电价与碳排放政策

#### 分时电价 (TOU Pricing)

| 时段 | 时间 | 电价 (¥/kWh) |
|------|------|--------------|
| 峰时 | 08:00-11:00, 18:00-21:00 | 1.0074 |
| 谷时 | 22:00-06:00 | 0.3128 |
| 平时 | 其他 | 0.6177 |

#### 官方碳排放因子 (沪环气〔2022〕34号)

| 能源类型 | 排放因子 | 单位 | 来源 |
|----------|----------|------|------|
| **电网电力** | 0.42 | tCO₂/MWh | 沪环气〔2022〕34号 |
| **绿色电力(PV)** | 0 | tCO₂/MWh | 外购绿电排放因子 |
| **热力** | 0.06 | tCO₂/GJ | 沪环气〔2022〕34号 |
| **燃气锅炉** | 0.06233 | tCO₂/GJ | 2024配额分配方案 |

#### 碳排放计算公式

```python
# 官方核算方法
碳排放 = (总用电 - PV自发自用) × 0.42 + 热力消耗 × 0.06

# 本项目为全电气化建筑，简化为：
碳排放 = 净购电量 × 0.42  # tCO₂
净购电量 = 总电力需求 - PV发电量
```

---

## 5. 输出变量配置 (v1.3 修正)

### 5.1 EnergyPlus 23.x 正确变量名

| 用途 | 变量名 | Key |
|------|--------|-----|
| HP 功率 | Heat Pump Electricity Rate | Central_ASHP |
| HP 产热 | Heat Pump Load Side Heat Transfer Rate | Central_ASHP |
| HP PLR | Heat Pump Part Load Ratio | Central_ASHP |
| 总需求 | Facility Total Electricity Demand Rate | * |
| 净购电 | Facility Net Purchased Electricity Rate | * |
| PV 发电 | Generator Produced DC Electricity Rate | Rooftop_PV_Array |

### 5.2 已清理的无效变量

- ~~Boiler Electricity Rate~~ (已替换为 HP)
- ~~NaturalGas:Facility~~ (全电气化后无效)
- ~~TES_Tank~~ (升级为 TES_Stratified)

---

## 6. 验证结果

### 6.1 仿真健康检查

```
✅ Zone Temperatures: 16.7°C - 27.0°C (合理范围)
✅ Heat Pump: 运行率 98.9%, 峰值 1.23 kW
✅ Chiller: 运行率 7.5%, 峰值 8.53 kW
✅ PV System: 峰值 45.8 kW, 年发电 31.79 MWh
✅ Self-Consumption: 64.1%
```

### 6.2 模型文件

- **输入**: `data/templates/5Zone_Base.idf`
- **输出**: `outputs/sim_building.idf`
- **固化版**: `outputs/sim_building_frozen.idf`
